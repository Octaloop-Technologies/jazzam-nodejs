name: Node.js CI/CD with Docker

on:
  push:
    branches:
      - main
      

jobs:
  build:
    runs-on: [self-hosted, main]

    steps:
      # 1. Checkout latest code
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2. Ensure project folder exists and set proper permissions
      - name: Set proper permissions for runner
        run: |
          mkdir -p $HOME/jazzam-nodejs-folder/jazzam-nodejs
          sudo chown -R $USER:$USER $HOME/jazzam-nodejs-folder/jazzam-nodejs

      # 3. Clear npm cache (on runner, not inside container)
      - name: Clear npm cache
        run: |
          echo "Clearing npm cache..."
          npm cache clean --force

      # 4. Stop & Remove Existing Container (if running)
      - name: Stop & Remove Existing Container
        run: |
          CONTAINER_ID=$(sudo docker ps -aq --filter "name=jazzam-backend-container")
          if [ ! -z "$CONTAINER_ID" ]; then
            echo "Stopping existing container..."
            sudo docker stop jazzam-backend-container
            sudo docker rm jazzam-backend-container
          fi

      # 5. Build Docker Image without using cache
      - name: Build Docker Image (no cache)
        run: |
          sudo docker build --no-cache -t jazzam-nodejs-image:latest .

      # 6. Run New Container
      - name: Run New Container
        run: |
          echo "Running new container..."
          sudo docker run -d -p 4001:4000 --name jazzam-backend-container jazzam-nodejs-image:latest

      # 7. Prune Unused Docker Resources
      - name: Prune Unused Docker Resources
        run: |
          echo "Cleaning up unused Docker resources..."
          sudo docker system prune -af --volumes

  nginx:
    runs-on: [self-hosted, main]
    needs: build
    steps:
      - name: Validate and Restart Nginx
        run: |
          echo "Testing Nginx configuration..."
          sudo nginx -t
          echo "Restarting Nginx..."
          sudo systemctl restart nginx
